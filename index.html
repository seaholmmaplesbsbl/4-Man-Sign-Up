<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seaholm Maples 4-Man Workouts</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #7F0000; color: white; font-family: Arial, sans-serif;
            margin: 0; padding: 15px; text-align: center;
        }
        header img { max-width: 100%; height: auto; margin-bottom: 10px; }
        h1 { margin: 10px 0; font-size: 1.5rem; }
        #calendar { margin: 20px auto; max-width: 400px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input[type="date"] { width: 100%; padding: 10px; font-size: 1rem; border-radius: 5px; border: none; }
        #time-slots { margin-top: 20px; min-height: 60px; }
        .slot-container { background: white; color: black; margin: 12px auto; max-width: 320px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .slot-header { padding: 12px; font-weight: bold; cursor: pointer; user-select: none; background: #f0f0f0; }
        .slot-header.full { background: #ccc; cursor: not-allowed; }
        .dropdown { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #fafafa; padding: 0 12px; }
        .dropdown.open { max-height: 300px; padding: 12px; }
        .player { margin: 6px 0; font-size: 0.9rem; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 100; }
        #modal-content { background: white; color: black; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .close { float: right; font-size: 1.8rem; cursor: pointer; }
        input[type="text"], input[type="email"], input[type="tel"], textarea, input[type="password"] { 
            width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; 
        }
        button { background: #7F0000; color: white; border: none; padding: 10px 16px; margin: 8px 4px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #5a0000; }
        #admin-section { margin-top: 50px; border-top: 1px solid white; padding-top: 20px; }
        #admin-tools { display: none; }
        .admin-slot { background: white; color: black; margin: 10px 0; padding: 12px; border-radius: 8px; }
        .remove-btn, .cancel-btn { background: #c00; font-size: 0.8rem; padding: 4px 8px; margin-left: 8px; }
        #info-box { background: white; color: black; margin: 20px auto; max-width: 400px; padding: 15px; border-radius: 8px; text-align: left; }
        #locked-message { color: #ffcc00; font-weight: bold; margin: 10px 0; }
        .extra-day { background: #e6f7ff; padding: 8px; margin: 5px 0; border-radius: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <img src="https://resources.finalsite.net/images/f_auto,q_auto,t_image_size_2/v1688066144/birminghamk12mius/rqaadhghytfsdcvod3yh/SEAMainII.png" alt="Seaholm Maples">
</header>
<h1>4-Man Workouts Sign-Up</h1>

<!-- INFO BOX -->
<div id="info-box">
    <div id="info-content">This week's workouts are open! Next week opens Sunday at 12:00 PM.</div>
</div>

<div id="calendar">
    <label for="date-picker">Select Date:</label>
    <input type="date" id="date-picker">
</div>

<div id="locked-message"></div>

<div id="time-slots">
    <p style="font-style:italic; color:#ddd;">Please select a date above.</p>
</div>

<!-- Sign-Up Modal -->
<div id="modal">
    <div id="modal-content">
        <span class="close" onclick="closeModal()">x</span>
        <h2>Your Info</h2>
        <form onsubmit="event.preventDefault(); submitSignup();">
            <input type="text" id="name" placeholder="Full Name" required>
            <input type="email" id="email" placeholder="Email" required>
            <input type="tel" id="phone" placeholder="Phone" required>
            <button type="submit">Sign Up</button>
        </form>
    </div>
</div>

<!-- Admin Panel -->
<div id="admin-section">
    <h2>Admin</h2>
    <div id="admin-login">
        <input type="password" id="admin-password" placeholder="Password">
        <button onclick="adminLogin()">Login</button>
    </div>
    <div id="admin-tools">
        <button onclick="adminLogout()">Logout</button>
        <h3>Edit Info Box</h3>
        <textarea id="info-text" rows="4" placeholder="Type your message here..."></textarea>
        <button onclick="saveInfoText()">Save Text</button>

        <h3>Manage Schedule</h3>
        <div style="margin: 15px 0;">
            <label>Add Extra Day (Tue, Thu, Sat, etc.):</label><br>
            <input type="date" id="add-extra-day"> 
            <button onclick="addExtraDay()">Add Day</button>
        </div>
        <label>Manage Date:</label>
        <input type="date" id="admin-date">
        <button onclick="cancelDate()" class="cancel-btn">Cancel This Date</button>
        <div id="admin-slots"></div>
    </div>
</div>

<script>
const ADMIN_PASS = 'maples2025';
const NORMAL_SLOTS = ['4:00 - 4:55', '5:00 - 5:55', '6:00 - 6:55', '7:00 - 7:55'];
const SAT_SLOTS = ['11:45 AM - 12:40 PM', '12:45 PM - 1:40 PM', '1:45 PM - 2:40 PM'];
let selectedDate = null;
let selectedSlot = null;

// BASE SCHEDULE (Mon, Wed, Fri)
const BASE_DATES = {
    '2025-11-03': 'Mon', '2025-11-05': 'Wed', '2025-11-07': 'Fri',
    '2025-11-10': 'Mon', '2025-11-12': 'Wed', '2025-11-14': 'Fri',
    '2025-11-17': 'Mon', '2025-11-19': 'Wed', '2025-11-21': 'Fri',
    '2025-11-24': 'Mon', '2025-11-26': 'Wed', '2025-11-28': 'Fri',
    '2025-12-01': 'Mon', '2025-12-03': 'Wed', '2025-12-05': 'Fri',
    '2025-12-08': 'Mon', '2025-12-10': 'Wed', '2025-12-12': 'Fri',
    '2025-12-15': 'Mon', '2025-12-17': 'Wed', '2025-12-19': 'Fri',
    '2025-12-22': 'Mon', '2025-12-29': 'Mon'
};

// GET THIS WEEK'S MONDAY
function getCurrentWeekMonday() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(now.setDate(diff));
    monday.setHours(0, 0, 0, 0);
    return monday;
}

// CHECK IF DATE IS IN CURRENT WEEK (Mon–Sun)
function isInCurrentWeek(dateStr) {
    const monday = getCurrentWeekMonday();
    const date = new Date(dateStr);
    date.setHours(0, 0, 0, 0);
    const nextMonday = new Date(monday);
    nextMonday.setDate(monday.getDate() + 7);
    return date >= monday && date < nextMonday;
}

// GET ALL OPEN DATES THIS WEEK
function getCurrentWeekOpenDates() {
    const monday = getCurrentWeekMonday();
    const dates = [];
    for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const str = d.toISOString().split('T')[0];
        if (BASE_DATES[str] || isExtraDay(str)) {
            dates.push(str);
        }
    }
    return dates;
}

function getNextWeekDates() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1) + 7;
    const monday = new Date(now.setDate(diff));
    monday.setHours(0,0,0,0);
    const dates = [];
    for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const str = d.toISOString().split('T')[0];
        if (BASE_DATES[str]) {
            dates.push(str);
        }
    }
    return dates;
}

function isThisWeek(date) {
    return getCurrentWeekOpenDates().includes(date);
}

function isExtraDay(date) {
    const extra = JSON.parse(localStorage.getItem('extra_days') || '[]');
    return extra.includes(date);
}

function unlockNextWeek() {
    const nextDates = getNextWeekDates();
    nextDates.forEach(d => {
        if (!localStorage.getItem(`workout_${d}`)) {
            initDay(d);
        }
    });
    localStorage.setItem('next_week_unlocked', 'true');
}

// SUNDAY 12:00 PM → UNLOCK NEXT WEEK
function checkSundayUnlock() {
    const now = new Date();
    const day = now.getDay();
    const hours = now.getHours();
    const minutes = now.getMinutes();

    if (day === 0 && hours === 12 && minutes === 0) {
        const lastShown = localStorage.getItem('sunday_unlock_shown');
        const today = now.toISOString().split('T')[0];
        if (lastShown !== today) {
            setTimeout(() => {
                alert("Next week's workouts are now open!");
                unlockNextWeek();
                localStorage.setItem('sunday_unlock_shown', today);
            }, 1000);
        }
    }
}
setInterval(checkSundayUnlock, 60000);

function getSlots(d) { 
    const dateObj = new Date(d);
    const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dateObj.getDay()];

    // Ensure Mon, Wed, Fri use NORMAL_SLOTS
    if (['Mon', 'Wed', 'Fri'].includes(dayName)) {
        return NORMAL_SLOTS;
    }

    // Sat and Sun use SAT_SLOTS
    if (['Sat', 'Sun'].includes(dayName)) {
        return SAT_SLOTS;
    }

    // Default to NORMAL_SLOTS for other weekdays (Tue, Thu)
    return NORMAL_SLOTS;
}
function initDay(d) {
    if (localStorage.getItem(key(d))) return;
    const slots = getSlots(d).reduce((o, s) => { o[s] = { avail: 4, players: [] }; return o; }, {});
    localStorage.setItem(key(d), JSON.stringify(slots));
}
function isOpenDay(d) { return isThisWeek(d); }

function loadInfoText() {
    const saved = localStorage.getItem('info_box_text');
    const content = document.getElementById('info-content');
    content.innerHTML = saved ? saved.replace(/\n/g, '<br>') : 'This week\'s workouts are open! Next week opens Sunday at 12:00 PM.';
}
function saveInfoText() {
    const text = document.getElementById('info-text').value;
    localStorage.setItem('info_box_text', text);
    loadInfoText();
    alert('Info box updated!');
}

document.getElementById('date-picker').addEventListener('change', loadPlayerSlots);

function loadPlayerSlots() {
    selectedDate = document.getElementById('date-picker').value;
    const container = document.getElementById('time-slots');
    const lockMsg = document.getElementById('locked-message');
    container.innerHTML = '';
    lockMsg.textContent = '';

    if (!selectedDate) {
        container.innerHTML = '<p style="font-style:italic; color:#ddd;">Please select a date above.</p>';
        return;
    }

    if (!isOpenDay(selectedDate)) {
        lockMsg.innerHTML = '<p>This date is not open yet. Next week opens Sunday at 12:00 PM.</p>';
        return;
    }

    initDay(selectedDate);
    const data = JSON.parse(localStorage.getItem(key(selectedDate)));
    const slots = getSlots(selectedDate);

    slots.forEach(slot => {
        const { avail, players } = data[slot];
        const wrap = document.createElement('div');
        wrap.className = 'slot-container';

        const header = document.createElement('div');
        header.className = 'slot-header' + (avail === 0 ? ' full' : '');
        header.textContent = `${slot} – ${avail} spot${avail===1?'':'s'} open`;
        
        header.onclick = () => {
            if (avail === 0) return;
            const drop = wrap.querySelector('.dropdown');
            drop.classList.toggle('open');
            document.querySelectorAll('.dropdown.open').forEach(d => {
                if (d !== drop) d.classList.remove('open');
            });
        };

        if (avail > 0) {
            header.ondblclick = () => {
                selectedSlot = slot;
                document.getElementById('modal').style.display = 'flex';
            };
        }

        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown';
        if (players.length === 0) {
            dropdown.innerHTML = '<em>No one signed up yet.</em>';
        } else {
            players.forEach(p => {
                const line = document.createElement('div');
                line.className = 'player';
                line.textContent = `${p.name} (${p.email})`;
                dropdown.appendChild(line);
            });
        }

        wrap.appendChild(header);
        wrap.appendChild(dropdown);
        container.appendChild(wrap);
    });
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

function submitSignup() {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    if (!name || !email || !phone) return alert('Fill all fields.');

    const data = JSON.parse(localStorage.getItem(key(selectedDate)));
    if (data[selectedSlot].avail > 0) {
        data[selectedSlot].avail--;
        data[selectedSlot].players.push({ name, email, phone });
        localStorage.setItem(key(selectedDate), JSON.stringify(data));
        alert('Signed up!');
        closeModal();
        loadPlayerSlots();
    } else {
        alert('Slot full!');
    }
}

window.onclick = e => { if (e.target === document.getElementById('modal')) closeModal(); };

// === ADMIN LOGIN FIXED ===
function adminLogin() {
    const password = document.getElementById('admin-password').value.trim();
    if (password === ADMIN_PASS) {
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('admin-tools').style.display = 'block';
        
        // Load saved text
        const savedText = localStorage.getItem('info_box_text') || 'This week\'s workouts are open! Next week opens Sunday at 12:00 PM.';
        document.getElementById('info-text').value = savedText;

        // Load admin panel
        loadAdmin();
    } else {
        alert('Wrong password. Try again.');
        document.getElementById('admin-password').value = '';
    }
}

function adminLogout() {
    document.getElementById('admin-tools').style.display = 'none';
    document.getElementById('admin-login').style.display = 'block';
    document.getElementById('admin-password').value = '';
    document.getElementById('admin-slots').innerHTML = '';
}

// === ADD EXTRA DAY ===
function addExtraDay() {
    const date = document.getElementById('add-extra-day').value;
    if (!date) return alert('Select a date to add.');

    if (!isInCurrentWeek(date)) {
        return alert('Can only add days for this week (Mon–Sun).');
    }

    let extra = JSON.parse(localStorage.getItem('extra_days') || '[]');
    if (extra.includes(date)) return alert('Day already added.');

    extra.push(date);
    localStorage.setItem('extra_days', JSON.stringify(extra));
    initDay(date);
    document.getElementById('add-extra-day').value = '';
    loadAdmin();
    if (document.getElementById('date-picker').value === date) loadPlayerSlots();
    alert(`Added ${date} to this week!`);
}

function cancelDate() {
    const date = document.getElementById('admin-date').value;
    if (!date) return alert('Select a date to cancel.');

    if (confirm(`Cancel ${date} and remove all sign-ups?`)) {
        localStorage.removeItem(key(date));
        let extra = JSON.parse(localStorage.getItem('extra_days') || '[]');
        const idx = extra.indexOf(date);
        if (idx > -1) {
            extra.splice(idx, 1);
            localStorage.setItem('extra_days', JSON.stringify(extra));
        }
        loadAdmin();
        if (document.getElementById('date-picker').value === date) {
            loadPlayerSlots();
        }
        alert(`Date ${date} canceled.`);
    }
}

// === LOAD ADMIN FIXED (forEach bug fixed) ===
function loadAdmin() {
    const date = document.getElementById('admin-date').value;
    const container = document.getElementById('admin-slots');
    container.innerHTML = '';
    if (!date) return;

    const extra = JSON.parse(localStorage.getItem('extra_days') || '[]');
    
    if (extra.length > 0) {
        const div = document.createElement('div');
        div.innerHTML = '<h4>Extra Days:</h4>';
        extra.forEach(day => {
            const span = document.createElement('span');
            span.className = 'extra-day';
            span.textContent = `${day} (Added)`;
            div.appendChild(span);
        });
        container.appendChild(div);
    }

    if (!isThisWeek(date)) {
        container.innerHTML += '<p>Not in current week.</p>';
        return;
    }

    initDay(date);
    const data = JSON.parse(localStorage.getItem(key(date)));
    const slots = getSlots(date);

    slots.forEach(slot => {
        const { avail, players } = data[slot];
        const div = document.createElement('div');
        div.className = 'admin-slot';
        div.innerHTML = `<strong>${slot}</strong> – ${avail} open<br>Players:`;
        const ul = document.createElement('ul');
        if (players.length === 0) {
            ul.innerHTML = '<em>None</em>';
        } else {
            players.forEach((p, i) => {  // FIXED: was `wearable`
                const li = document.createElement('li');
                li.innerHTML = `${p.name} (${p.email}) `;
                const rm = document.createElement('button');
                rm.className = 'remove-btn';
                rm.textContent = 'Remove';
                rm.onclick = () => {
                    data[slot].players.splice(i, 1);
                    data[slot].avail++;
                    localStorage.setItem(key(date), JSON.stringify(data));
                    loadAdmin();
                };
                li.appendChild(rm);
                ul.appendChild(li);
            });
        }
        div.appendChild(ul);
        container.appendChild(div);
    });
}

window.onload = () => {
    loadInfoText();
    document.getElementById('time-slots').innerHTML = '<p style="font-style:italic; color:#ddd;">Please select a date above.</p>';
    checkSundayUnlock();
};
</script>

</body>

</html>
